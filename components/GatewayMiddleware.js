var log=(...e)=>{};function initialize(e){e.config.debug&&(log=(...e)=>{console.log("[GATEWAY]",...e)}),log("EXT plugins in database:",e.Gateway.EXT.length),e.config.username||e.config.password?(e.config.username!=e.Gateway.user.username&&e.config.password!=e.Gateway.user.password||(console.warn("[GATEWAY] WARN: You are using default username or default password"),console.warn("[GATEWAY] WARN: Don't forget to change it!")),e.Gateway.user.username=e.config.username,e.Gateway.user.password=e.config.password):(console.error("[GATEWAY] Your have not defined user/password in config!"),console.error("[GATEWAY] Using default credentials")),passportConfig(e),e.Gateway.app=e.lib.express(),e.Gateway.server=e.lib.http.createServer(e.Gateway.app),e.Gateway.EXTConfigured=e.lib.GWTools.searchConfigured(e.Gateway.MMConfig,e.Gateway.EXT),e.Gateway.EXTInstalled=e.lib.GWTools.searchInstalled(e),log("Find",e.Gateway.EXTInstalled.length,"installed plugins in MagicMirror"),log("Find",e.Gateway.EXTConfigured.length,"configured plugins in config file"),e.Gateway.GACheck.version&&e.lib.semver.gte(e.Gateway.GACheck.version,"5.1.0")?(e.Gateway.GACheck.find=!0,log("Find MMM-GoogleAssistant v"+e.Gateway.GACheck.version)):console.warn("[GATEWAY] MMM-GoogleAssistant Not Found!"),Object.keys(e.Gateway.GAConfig).length>0?(log("Find MMM-GoogleAssistant configured in MagicMirror"),e.Gateway.GACheck.configured=!0):log("MMM-GoogleAssistant is not configured!"),log("webviewTag Configured:",e.Gateway.webviewTag),log("Language set",e.Gateway.language),createGW(e)}function createGW(e){e.config.debug&&(log=(...e)=>{console.log("[GATEWAY]",...e)});var t=e.path,a=e.lib.bodyParser.urlencoded({extended:!0});log("Create Gateway needed routes..."),e.Gateway.app.use(e.lib.session({secret:"some-secret",saveUninitialized:!1,resave:!0})),e.Gateway.app.use(e.lib.bodyParser.json()),e.Gateway.app.use(e.lib.bodyParser.urlencoded({extended:!0})),e.Gateway.app.use(e.lib.passport.initialize()),e.Gateway.app.use(e.lib.passport.session());var s={dotfiles:"ignore",etag:!1,extensions:["css","js"],index:!1,maxAge:"1d",redirect:!1,setHeaders:function(e,t,a){e.set("x-timestamp",Date.now())}},o=function(e,t){t.redirect("/")},n=new e.lib.Socket.Server(e.Gateway.server);e.Gateway.app.use(logRequest).use(e.lib.cors({origin:"*"})).use("/EXT_Tools.js",e.lib.express.static(t+"/tools/EXT_Tools.js")).use("/assets",e.lib.express.static(t+"/website/assets",s)).get("/",((e,a)=>{e.user?a.sendFile(t+"/website/Gateway/index.html"):a.redirect("/login")})).get("/version",((t,a)=>{var s={v:require("../package.json").version,rev:require("../package.json").rev,lang:e.Gateway.language,last:0,needUpdate:!1};e.lib.fetch("https://raw.githubusercontent.com/bugsounet/Gateway/master/package.json").then((e=>e.json())).then((t=>{s.last=t.version,e.lib.semver.gt(s.last,s.v)&&(s.needUpdate=!0),a.send(s)})).catch((e=>{console.error("[GATEWAY] Error on fetch last version number"),a.send(s)}))})).get("/translation",((t,a)=>{a.send(e.Gateway.translation)})).get("/EXT",((e,a)=>{e.user?a.sendFile(t+"/website/Gateway/EXT.html"):a.redirect("/login")})).get("/login",((e,a)=>{e.user&&a.redirect("/"),a.sendFile(t+"/website/Gateway/login.html")})).post("/auth",((t,a,s)=>{var o=t.headers["x-forwarded-for"]||t.connection.remoteAddress;e.lib.passport.authenticate("login",((e,n,i)=>e?(console.log("[GATEWAY] ["+o+"] Error",e),s(e)):n?void t.logIn(n,(e=>e?(console.log("[GATEWAY] ["+o+"] Login error:",e),a.send({err:e})):(console.log("[GATEWAY] ["+o+"] Welcome "+n.username+", happy to serve you!"),a.send({login:!0})))):(console.log("[GATEWAY] ["+o+"] Bad Login",i),a.send({err:i}))))(t,a,s)})).get("/logout",((e,t)=>{e.logout((e=>{if(e)return console.error("[GATEWAY] Logout:",e);t.redirect("/")}))})).get("/AllEXT",((a,s)=>{a.user?s.send(e.Gateway.EXT):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/DescriptionEXT",((a,s)=>{a.user?s.send(e.Gateway.EXTDescription):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/InstalledEXT",((a,s)=>{a.user?s.send(e.Gateway.EXTInstalled):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/ConfiguredEXT",((a,s)=>{a.user?s.send(e.Gateway.EXTConfigured):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/GetMMConfig",((a,s)=>{a.user?s.send(e.Gateway.MMConfig):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/Terminal",((a,s)=>{if(a.user){var o=a.headers["x-forwarded-for"]||a.connection.remoteAddress;s.sendFile(t+"/website/Gateway/terminal.html"),n.once("connection",(async t=>{log("["+o+"] Connected to Terminal Logs:",a.user.username),t.on("disconnect",(e=>{log("["+o+"] Disconnected from Terminal Logs:",a.user.username,"["+e+"]")}));var s=await e.lib.GWTools.readAllMMLogs(e.Gateway.HyperWatch.logs());n.emit("terminal.logs",s),e.Gateway.HyperWatch.stream().on("stdData",(e=>{"string"==typeof e&&n.to(t.id).emit("terminal.logs",e.replace(/\r?\n/g,"\r\n"))}))}))}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/ptyProcess",((a,s)=>{if(a.user){var o=a.headers["x-forwarded-for"]||a.connection.remoteAddress;s.sendFile(t+"/website/Gateway/pty.html"),n.once("connection",(t=>{log("["+o+"] Connected to Terminal:",a.user.username),t.on("disconnect",(e=>{log("["+o+"] Disconnected from Terminal:",a.user.username,"["+e+"]")}));var s=e.lib.pty.spawn("bash",[],{name:"xterm-color",cols:80,rows:24,cmd:process.env.HOME,env:process.env});s.on("data",(e=>{n.to(t.id).emit("terminal.incData",e)})),t.on("terminal.toTerm",(e=>{s.write(e)})),t.on("terminal.size",(e=>{s.resize(e.cols,e.rows)}))}))}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/install",((a,s)=>{if(a.user){var o=a.headers["x-forwarded-for"]||a.connection.remoteAddress;a.query.ext&&-1==e.Gateway.EXTInstalled.indexOf(a.query.ext)&&e.Gateway.EXT.indexOf(a.query.ext)>-1?(s.sendFile(t+"/website/Gateway/install.html"),n.once("connection",(async t=>{log("["+o+"] Connected to installer Terminal Logs:",a.user.username),t.on("disconnect",(e=>{log("["+o+"] Disconnected from installer Terminal Logs:",a.user.username,"["+e+"]")})),e.Gateway.HyperWatch.stream().on("stdData",(e=>{"string"==typeof e&&n.to(t.id).emit("terminal.installer",e.replace(/\r?\n/g,"\r\n"))}))}))):s.status(404).sendFile(t+"/website/Gateway/404.html")}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTInstall",((a,s)=>{if(a.user){var o=a.headers["x-forwarded-for"]||a.connection.remoteAddress;if(a.query.EXT&&-1==e.Gateway.EXTInstalled.indexOf(a.query.EXT)&&e.Gateway.EXT.indexOf(a.query.EXT)>-1){console.log("[GATEWAY]["+o+"] Request installation:",a.query.EXT);var n={error:!1},i=e.lib.path.normalize(t+"/../"),r="cd "+i+" && git clone https://github.com/bugsounet/"+a.query.EXT+" && cd "+a.query.EXT+" && npm install",l=e.lib.childProcess.exec(r,{cwd:i},((t,o,i)=>{t?(n.error=!0,console.error(`[GATEWAY][FATAL] exec error: ${t}`)):(e.Gateway.EXTInstalled=e.lib.GWTools.searchInstalled(e),console.log("[GATEWAY][DONE]",a.query.EXT)),s.json(n)}));l.stdout.pipe(process.stdout),l.stderr.pipe(process.stdout)}else s.status(404).sendFile(t+"/website/Gateway/404.html")}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/delete",((a,s)=>{if(a.user){var o=a.headers["x-forwarded-for"]||a.connection.remoteAddress;a.query.ext&&e.Gateway.EXTInstalled.indexOf(a.query.ext)>-1&&e.Gateway.EXT.indexOf(a.query.ext)>-1?(s.sendFile(t+"/website/Gateway/delete.html"),n.once("connection",(async t=>{log("["+o+"] Connected to uninstaller Terminal Logs:",a.user.username),t.on("disconnect",(e=>{log("["+o+"] Disconnected from uninstaller Terminal Logs:",a.user.username,"["+e+"]")})),e.Gateway.HyperWatch.stream().on("stdData",(e=>{"string"==typeof e&&n.to(t.id).emit("terminal.delete",e.replace(/\r?\n/g,"\r\n"))}))}))):s.status(404).sendFile(t+"/website/Gateway/404.html")}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTDelete",((a,s)=>{if(a.user){var o=a.headers["x-forwarded-for"]||a.connection.remoteAddress;if(a.query.EXT&&e.Gateway.EXTInstalled.indexOf(a.query.EXT)>-1&&e.Gateway.EXT.indexOf(a.query.EXT)>-1){console.log("[GATEWAY]["+o+"] Request delete:",a.query.EXT);var n={error:!1},i=e.lib.path.normalize(t+"/../"),r="cd "+i+" && rm -rfv "+a.query.EXT,l=e.lib.childProcess.exec(r,{cwd:i},((t,o,i)=>{t?(n.error=!0,console.error(`[GATEWAY][FATAL] exec error: ${t}`)):(e.Gateway.EXTInstalled=e.lib.GWTools.searchInstalled(e),console.log("[GATEWAY][DONE]",a.query.EXT)),s.json(n)}));l.stdout.pipe(process.stdout),l.stderr.pipe(process.stdout)}else s.status(404).sendFile(t+"/website/Gateway/404.html")}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/MMConfig",((e,a)=>{e.user?a.sendFile(t+"/website/Gateway/mmconfig.html"):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTCreateConfig",((a,s)=>{a.user?a.query.ext&&e.Gateway.EXTInstalled.indexOf(a.query.ext)>-1&&e.Gateway.EXT.indexOf(a.query.ext)>-1&&-1==e.Gateway.EXTConfigured.indexOf(a.query.ext)?s.sendFile(t+"/website/Gateway/EXTCreateConfig.html"):s.status(404).sendFile(t+"/website/Gateway/404.html"):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTModifyConfig",((a,s)=>{a.user?a.query.ext&&e.Gateway.EXTInstalled.indexOf(a.query.ext)>-1&&e.Gateway.EXT.indexOf(a.query.ext)>-1&&e.Gateway.EXTConfigured.indexOf(a.query.ext)>-1?s.sendFile(t+"/website/Gateway/EXTModifyConfig.html"):s.status(404).sendFile(t+"/website/Gateway/404.html"):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTDeleteConfig",((a,s)=>{a.user?a.query.ext&&-1==e.Gateway.EXTInstalled.indexOf(a.query.ext)&&e.Gateway.EXT.indexOf(a.query.ext)>-1&&e.Gateway.EXTConfigured.indexOf(a.query.ext)>-1?s.sendFile(t+"/website/Gateway/EXTDeleteConfig.html"):s.status(404).sendFile(t+"/website/Gateway/404.html"):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTGetCurrentConfig",((a,s)=>{if(a.user){if(!a.query.ext)return s.status(404).sendFile(t+"/website/Gateway/404.html");var o=e.Gateway.MMConfig.modules.map((e=>e.module)).indexOf(a.query.ext);if(o>-1){let t=e.Gateway.MMConfig.modules[o];return s.send(t)}s.status(404).sendFile(t+"/website/Gateway/404.html")}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTGetDefaultConfig",((e,a)=>{if(e.user){if(!e.query.ext)return a.status(404).sendFile(t+"/website/Gateway/404.html");let s=require("../config/"+e.query.ext+"/config.js");a.send(s.default)}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTGetDefaultTemplate",((a,s)=>{if(a.user){if(!a.query.ext)return s.status(404).sendFile(t+"/website/Gateway/404.html");let o=require("../config/"+a.query.ext+"/config.js");o.schema=e.lib.GWTools.makeSchemaTranslate(o.schema,e.Gateway.schemaTranslatation),s.send(o.schema)}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EXTSaveConfig",((e,a)=>{if(e.user){if(!e.query.config)return a.status(404).sendFile(t+"/website/Gateway/404.html");let s=e.query.config;a.send(s)}else a.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/writeEXT",(async(t,a)=>{console.log("[Gateway] Receiving EXT data ...");let s=JSON.parse(t.body.data);var o=await e.lib.GWTools.configAddOrModify(s,e.Gateway.MMConfig),n=await e.lib.GWTools.saveConfig(e,o);console.log("[GATEWAY] Write config result:",n),a.send(n),n.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),e.Gateway.EXTConfigured=e.lib.GWTools.searchConfigured(e.Gateway.MMConfig,e.Gateway.EXT),console.log("[GATEWAY] Reload config"))})).post("/deleteEXT",(async(t,a)=>{console.log("[Gateway] Receiving EXT data ...",t.body);let s=t.body.data;var o=await e.lib.GWTools.configDelete(s,e.Gateway.MMConfig),n=await e.lib.GWTools.saveConfig(e,o);console.log("[GATEWAY] Write config result:",n),a.send(n),n.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),e.Gateway.EXTConfigured=e.lib.GWTools.searchConfigured(e.Gateway.MMConfig,e.Gateway.EXT),console.log("[GATEWAY] Reload config"))})).get("/Tools",((e,a)=>{e.user?a.sendFile(t+"/website/Gateway/tools.html"):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/Setting",((e,a)=>{e.user?a.sendFile(t+"/website/Gateway/setting.html"):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/getSetting",((a,s)=>{a.user?s.send(e.config):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/Restart",((a,s)=>{a.user?(s.sendFile(t+"/website/Gateway/restarting.html"),setTimeout((()=>e.lib.GWTools.restartMM(e)),1e3)):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/Die",((a,s)=>{a.user?(s.sendFile(t+"/website/Gateway/die.html"),setTimeout((()=>e.lib.GWTools.doClose(e)),3e3)):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/EditMMConfig",((e,a)=>{e.user?a.sendFile(t+"/website/Gateway/EditMMConfig.html"):a.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/GetBackupName",(async(a,s)=>{if(a.user){var o=await e.lib.GWTools.loadBackupNames(e);s.send(o)}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/GetBackupFile",(async(a,s)=>{if(a.user){let t=a.query.config;var o=await e.lib.GWTools.loadBackupFile(e,t);s.send(o)}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/GetRadioStations",((a,s)=>{if(a.user){if(!e.Gateway.radio)return s.status(404).sendFile(t+"/website/Gateway/404.html");var o=Object.keys(e.Gateway.radio);s.send(o)}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/loadBackup",(async(t,a)=>{console.log("[Gateway] Receiving backup data ...");let s=t.body.data;var o=await e.lib.GWTools.loadBackupFile(e,s),n=await e.lib.GWTools.saveConfig(e,o);console.log("[GATEWAY] Write config result:",n),a.send(n),n.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),console.log("[GATEWAY] Reload config"))})).post("/writeConfig",(async(t,a)=>{console.log("[Gateway] Receiving config data ...");let s=JSON.parse(t.body.data);var o=await e.lib.GWTools.saveConfig(e,s);console.log("[GATEWAY] Write config result:",o),a.send(o),o.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),console.log("[GATEWAY] Reload config"))})).post("/saveSetting",a,(async(t,a)=>{console.log("[Gateway] Receiving new Setting");let s=JSON.parse(t.body.data);var o=await e.lib.GWTools.configAddOrModify(s,e.Gateway.MMConfig),n=await e.lib.GWTools.saveConfig(e,o);console.log("[GATEWAY] Write Gateway config result:",n),a.send(n),n.done&&(e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),console.log("[GATEWAY] Reload config"))})).get("/getWebviewTag",((a,s)=>{a.user?s.send(e.Gateway.webviewTag):s.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/setWebviewTag",(async(a,s)=>{if(!e.Gateway.webviewTag&&a.user){console.log("[Gateway] Receiving setWebviewTag demand...");let t=await e.lib.GWTools.setWebviewTag(e.Gateway.MMConfig);var o=await e.lib.GWTools.saveConfig(e,t);console.log("[GATEWAY] Write Gateway webview config result:",o),s.send(o),o.done&&(e.Gateway.webviewTag=!0,e.Gateway.MMConfig=await e.lib.GWTools.readConfig(e),console.log("[GATEWAY] Reload config"))}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/getGAVersion",((a,s)=>{a.user?(e.Gateway.EXTStatus.GA_Ready&&(e.Gateway.GACheck.ready=!0),s.send(e.Gateway.GACheck)):s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/getEXTStatus",((a,s)=>{a.user?s.send(e.Gateway.EXTStatus):s.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/EXT-Screen",((t,a)=>{if(t.user){let s=t.body.data;if("OFF"==s)return e.sendSocketNotification("SendNoti","EXT_SCREEN-END"),a.send("ok");if("ON"==s)return e.sendSocketNotification("SendNoti","EXT_SCREEN-WAKEUP"),a.send("ok");a.send("error")}else a.send("error")})).post("/EXT-GAQuery",((t,a)=>{if(t.user){let s=t.body.data;if(!s)return a.send("error");e.sendSocketNotification("SendNoti",{noti:"GA_ACTIVATE",payload:{type:"TEXT",key:s}}),a.send("ok")}else a.send("error")})).post("/EXT-AlertQuery",((t,a)=>{if(t.user){let s=t.body.data;if(!s)return a.send("error");e.sendSocketNotification("SendNoti",{noti:"EXT_ALERT",payload:{type:"information",message:s,sender:t.user?t.user.username:"Gateway",timer:3e4,sound:"modules/Gateway/tools/message.mp3",icon:"modules/Gateway/website/assets/img/gateway.jpg"}}),a.send("ok")}else a.send("error")})).post("/EXT-VolumeSendSpeaker",((t,a)=>{if(t.user){let s=t.body.data;if(!s)return a.send("error");e.sendSocketNotification("SendNoti",{noti:"EXT_VOLUME-SPEAKER_SET",payload:s}),a.send("ok")}else a.send("error")})).post("/EXT-VolumeSendRecorder",((t,a)=>{if(t.user){let s=t.body.data;if(!s)return a.send("error");e.sendSocketNotification("SendNoti",{noti:"EXT_VOLUME-RECORDER_SET",payload:s}),a.send("ok")}else a.send("error")})).post("/EXT-SpotifyQuery",((t,a)=>{if(t.user){if(!t.body.data)return a.send("error");let o=t.body.data.query,n=t.body.data.type;if(!o||!n)return a.send("error");var s={type:n,query:o,random:!1};e.sendSocketNotification("SendNoti",{noti:"EXT_SPOTIFY-SEARCH",payload:s}),a.send("ok")}else a.send("error")})).post("/EXT-SpotifyPlay",((t,a)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_SPOTIFY-PLAY"),a.send("ok")):a.send("error")})).post("/EXT-SpotifyStop",((t,a)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_SPOTIFY-STOP"),a.send("ok")):a.send("error")})).post("/EXT-SpotifyNext",((t,a)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_SPOTIFY-NEXT"),a.send("ok")):a.send("error")})).post("/EXT-SpotifyPrevious",((t,a)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_SPOTIFY-PREVIOUS"),a.send("ok")):a.send("error")})).post("/EXT-UNUpdate",((t,a)=>{t.user?(e.sendSocketNotification("SendNoti","EXT_UPDATENOTIFICATION-UPDATE"),a.send("ok")):a.send("error")})).post("/EXT-YouTubeQuery",((t,a)=>{if(t.user){let s=t.body.data;if(!s)return a.send("error");e.Gateway.EXTStatus["EXT-YouTube"].hello?(e.sendSocketNotification("SendNoti",{noti:"EXT_YOUTUBE-SEARCH",payload:s}),a.send("ok")):a.send("error")}else a.send("error")})).post("/EXT-FreeboxTVQuery",((t,a)=>{if(t.user||!e.Gateway.freeteuse){let s=t.body.data;if(!s)return a.send("error");e.sendSocketNotification("SendNoti",{noti:"EXT_FREEBOXTV-PLAY",payload:s}),a.send("ok")}else a.send("error")})).post("/EXT-RadioQuery",((t,a)=>{if(t.user){let o=t.body.data;if(!o)return a.send("error");try{var s=e.Gateway.radio[o].notificationExec.payload();e.sendSocketNotification("SendNoti",{noti:"EXT_RADIO-START",payload:s})}catch(e){a.send("error")}a.send("ok")}else a.send("error")})).post("/EXT-StopQuery",((t,a)=>{t.user?(e.sendSocketNotification("SendStop"),e.sendSocketNotification("SendNoti","EXT_STOP"),a.send("ok")):a.send("error")})).post("/deleteBackup",(async(a,s)=>{if(a.user){console.log("[GATEWAY] Receiving delete backup demand...");var o=await e.lib.GWTools.deleteBackup(e);console.log("[GATEWAY] Delete backup result:",o),s.send(o)}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/readExternalBackup",(async(a,s)=>{if(a.user){let t=a.body.data;if(!t)return s.send({error:"error"});console.log("[GATEWAY] Receiving External backup...");var o=await e.lib.GWTools.transformExternalBackup(e,t);s.send({data:o})}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).post("/saveExternalBackup",(async(a,s)=>{if(a.user){let i=a.body.data;if(!i)return s.send({error:"error"});console.log("[GATEWAY] Receiving External backup...");var n=await e.lib.GWTools.saveExternalConfig(e,i);n.data&&(console.log("[GATEWAY] Generate link number:",n.data),o=(a,s)=>{a.params[0]==n.data?(s.sendFile(t+"/download/"+n.data+".js"),o=function(e,t){t.redirect("/")},setTimeout((()=>{e.lib.GWTools.deleteDownload(e,n.data)}),1e4)):s.redirect("/")}),s.send(n)}else s.status(403).sendFile(t+"/website/Gateway/403.html")})).get("/download/*",((e,t)=>{o(e,t)})).get("/robots.txt",((e,a)=>{a.sendFile(t+"/website/Gateway/robots.txt")})).use("/jsoneditor",e.lib.express.static(t+"/node_modules/jsoneditor")).use("/xterm",e.lib.express.static(t+"/node_modules/xterm")).use("/xterm-addon-fit",e.lib.express.static(t+"/node_modules/xterm-addon-fit"))}async function startServer(e,t=(()=>{})){e.Gateway.app.get("/smarthome/*",((t,a)=>{console.warn("[GATEWAY] [SMARTHOME] Don't find:",t.url),a.status(404).sendFile(e.path+"/website/SmartHome/404.html")})),e.Gateway.app.get("/*",((t,a)=>{console.warn("[GATEWAY] Don't find:",t.url),a.status(404).sendFile(e.path+"/website/Gateway/404.html")})),e.config.listening=await e.lib.GWTools.purposeIP(e),e.Gateway.HyperWatch=e.lib.hyperwatch(e.Gateway.server.listen(8081,"0.0.0.0",(()=>{console.log("[GATEWAY] Start listening on port 8081"),console.log("[GATEWAY] Available locally at http://"+e.config.listening+":8081"),e.Gateway.initialized=!0,t(!0)})).on("error",(a=>{console.error("[GATEWAY] Can't start Gateway server!"),console.error("[GATEWAY] Error:",a.message),e.sendSocketNotification("SendNoti",{noti:"EXT_ALERT",payload:{type:"error",message:"Can't start Gateway server!",timer:1e4}}),e.Gateway.initialized=!1,t(!1)})))}function passportConfig(e){e.lib.passport.use("login",new e.lib.LocalStrategy.Strategy(((t,a,s)=>{if(t===e.Gateway.user.username&&a===e.Gateway.user.password)return s(null,e.Gateway.user);s(null,!1,{message:e.Gateway.translation.Login_Error})}))),e.lib.passport.serializeUser(((e,t)=>{t(null,e._id)})),e.lib.passport.deserializeUser(((t,a)=>{a(null,e.Gateway.user)}))}function logRequest(e,t,a){var s=e.headers["x-forwarded-for"]||e.connection.remoteAddress;log("["+s+"]["+e.method+"] "+e.url),a()}exports.initialize=initialize,exports.startServer=startServer;