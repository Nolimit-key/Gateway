function readConfig(e){return new Promise((r=>{var n=void 0;let o=e.lib.path.resolve(__dirname,"../../../config/config.js");e.lib.fs.existsSync(o)&&(n=configStartMerge(n=require(o))),r(n)}))}function readTMPBackupConfig(e,r){return new Promise((n=>{var o=void 0;e.lib.fs.existsSync(r)&&(o=configStartMerge(o=require(r)),e.lib.fs.unlink(r,(e=>{if(e)return console.error("[GATEWAY] error",e)})),n(o))}))}function readFreeteuseTV(e){return new Promise((r=>{var n=void 0;let o=e.lib.path.resolve(__dirname,"../../EXT-FreeboxTV/streamsConfig.json");e.lib.fs.existsSync(o)&&(n=require(o)),r(n)}))}function readRadioRecipe(e){return new Promise((r=>{var n=void 0,o=e.Gateway.language;let t=e.lib.path.resolve(__dirname,"../../EXT-RadioPlayer/recipe/EXT-RadioPlayer."+o+".js");try{e.lib.fs.existsSync(t)&&(n=require(t).recipe.commands)}catch(e){r(n),console.error("[GATEWAY] [Radio] error when loading file",t)}r(n)}))}function searchConfigured(e,r){try{var n=[];return e.modules.find((e=>{r.includes(e.module)&&n.push(e.module)})),n.sort()}catch(e){return console.log("[GATEWAY] Error! "+e),n.sort()}}function searchInstalled(e){var r=[];return e.Gateway.EXT.find((n=>{if(e.lib.fs.existsSync(e.lib.path.resolve(__dirname+"/../../"+n+"/package.json"))){let o=require(e.lib.path.resolve(__dirname+"/../../"+n+"/package.json")).name;o==n?r.push(n):console.warn("[GATEWAY] Found:",n,"but in package.json name is not the same:",o)}})),r.sort()}function searchGA(e){var r=0;if(e.lib.fs.existsSync(e.lib.path.resolve(__dirname+"/../../MMM-GoogleAssistant/package.json"))){let n=require(e.lib.path.resolve(__dirname+"/../../MMM-GoogleAssistant/package.json")).name;"MMM-GoogleAssistant"==n?r=require(e.lib.path.resolve(__dirname+"/../../MMM-GoogleAssistant/package.json")).version:console.warn("[GATEWAY] Found: MMM-GoogleAssistant but in package.json name is not the same:",n)}return r}function timeStamp(){for(var e=new Date,r=[e.getFullYear(),e.getMonth()+1,e.getDate()],n=[e.getHours(),e.getMinutes(),e.getSeconds()],o=0;o<3;o++)n[o]<10&&(n[o]="0"+n[o]),r[o]<10&&(r[o]="0"+r[o]);return r.join("")+"-"+n.join(":")}function saveConfig(e,r){return new Promise((n=>{var o=e.lib.path.resolve(__dirname,"../../../config/config.js"),t=e.lib.path.resolve(__dirname,"../../../config/configTMP.js");let i=e.lib.path.resolve(__dirname,"../backup/config.js.GW."+timeStamp());var a=e.lib.fs.createReadStream(o),s=e.lib.fs.createWriteStream(i);a.pipe(s,{end:!1}),a.on("end",(()=>{var a="/*** GENERATED BY @bugsounet Gateway v"+require("../package.json").version+" ***/\n/*** https://forum.bugsounet.fr **/\n\nvar config = ";e.lib.fs.writeFile(t,a+e.lib.util.inspect(r,{showHidden:!1,depth:null,maxArrayLength:null,compact:!1})+"\n\n/*************** DO NOT EDIT THE LINE BELOW ***************/\nif (typeof module !== 'undefined') {module.exports = config;}\n",(r=>{if(r)return n({error:"Error when writing file"}),console.error("[GATEWAY] error",r);console.log("[GATEWAY] Gateway saved TMP configuration!"),console.log("[GATEWAY] Backup saved in",i),console.log("[GATEWAY] Gateway check Function in config and revive it...");var a=new RegExp(/(.*)(`|')\[FUNCTION\](.*)(`|')/,"g");!function(r,o){e.lib.fs.unlink(o,(e=>{if(e)return n({error:"Error when deleting file"}),console.error("[GATEWAY] error",e)}));var t=e.lib.fs.createReadStream(r),i=new e.lib.Stream;i.readable=!0,i.writable=!0,e.lib.readline.createInterface({input:t,output:i,terminal:!1}).on("line",(r=>{var n=a.exec(r);if(n)return r=reviver(n),e.lib.fs.appendFileSync(o,r+"\n");e.lib.fs.appendFileSync(o,r+"\n")})),t.on("end",(()=>{e.lib.fs.unlink(r,(e=>{if(e)return n({error:"Error when deleting file"}),console.error("[GATEWAY] error",e);n({done:"ok"})}))}))}(t,o)}))})),s.on("error",(e=>{n({error:"Error when writing file"}),console.log("[GATEWAY]",e)}))}))}function saveExternalConfig(e,r){return new Promise((n=>{var o=Date.now(),t=e.lib.path.resolve(__dirname,"../tmp/configTMP.js"),i=e.lib.path.resolve(__dirname,"../download/"+o+".js"),a="/*** GENERATED BY @bugsounet Gateway v"+require("../package.json").version+" ***/\n/*** https://forum.bugsounet.fr **/\n\nvar config = ";e.lib.fs.writeFile(t,a+e.lib.util.inspect(r,{showHidden:!1,depth:null,maxArrayLength:null,compact:!1})+"\n\n/*************** DO NOT EDIT THE LINE BELOW ***************/\nif (typeof module !== 'undefined') {module.exports = config;}\n",(r=>{if(r)return n({error:"Error when writing file"}),console.error("[GATEWAY] error",r);var a,s,l,c,f=new RegExp(/(.*)(`|')\[FUNCTION\](.*)(`|')/,"g");a=t,s=i,l=e.lib.fs.createReadStream(a),(c=new e.lib.Stream).readable=!0,c.writable=!0,e.lib.readline.createInterface({input:l,output:c,terminal:!1}).on("line",(r=>{var n=f.exec(r);if(n)return r=reviver(n),e.lib.fs.appendFileSync(s,r+"\n");e.lib.fs.appendFileSync(s,r+"\n")})),l.on("end",(()=>{console.log("[GATEWAY] Gateway saved new backup configuration for downloading !"),e.lib.fs.unlink(a,(e=>{if(e)return n({error:"Error when deleting file"}),console.error("[GATEWAY] error",e);n({data:o})}))}))}))}))}function deleteDownload(e,r){var n=e.lib.path.resolve(__dirname,"../download/"+r+".js");e.lib.fs.unlink(n,(e=>{if(e)return console.error("[GATEWAY] error",e);console.log("[GATEWAY] Successfully deleted:",n)}))}function transformExternalBackup(e,r){return new Promise((n=>{var o=e.lib.path.resolve(__dirname,"../tmp/config.tmp"+timeStamp());e.lib.fs.writeFile(o,r,(async r=>{r?(console.log("[GATEWAY][externalBackup]",r),n({error:"Error when writing external tmp backup file"})):(result=await readTMPBackupConfig(e,o),n(result))}))}))}function configAddOrModify(e,r){return new Promise((n=>{modules=r.modules,index=modules.map((e=>e.module)).indexOf(e.module),index>-1?modules[index]=e:modules.push(e),n(r)}))}function configDelete(e,r){return new Promise((n=>{modules=r.modules,index=modules.map((e=>e.module)).indexOf(e),modules.splice(index,1),n(r)}))}function loadBackupNames(e){return new Promise((r=>{var n=[];e.lib.fs.readdirSync(e.lib.path.resolve(__dirname,"../backup/")).forEach((e=>{e.match("config.js.GW")&&n.push(e)})),n.sort(),n.reverse(),r(n)}))}function deleteBackup(e){return new Promise((r=>{e.lib.fs.readdirSync(e.lib.path.resolve(__dirname,"../backup/")).forEach((r=>{if(r.match("config.js.GW")){pathFile=e.lib.path.resolve(__dirname,"../backup/"+r);try{e.lib.fs.unlinkSync(pathFile)}catch(e){console.error("[GATEWAY] Error occurred while trying to remove this file:",r)}}})),r({done:"ok"})}))}function loadBackupFile(e,r){return new Promise((n=>{var o={};let t=e.lib.path.resolve(__dirname,"../backup/"+r);e.lib.fs.existsSync(t)&&(o=configStartMerge(o=require(t))),n(o)}))}function getIP(e){return new Promise((r=>{e.lib.si.networkInterfaceDefault().then((n=>{e.lib.si.networkInterfaces().then((e=>{var o=[],t=0;e.forEach((i=>{var a={};"wireless"==i.type&&(a={ip:i.ip4?i.ip4:"unknow",default:i.iface==n}),"wired"==i.type&&(a={ip:i.ip4?i.ip4:"unknow",default:i.iface==n}),"lo"!=i.iface&&o.push(a),t==e.length-1?r(o):t+=1}))}))})).catch((e=>{console.log(e);var n;n={ip:"127.0.0.1",default:!0},Interfaces.push(n),r(Interfaces)}))}))}async function purposeIP(e){var r=await getIP(e),n=0;return new Promise((e=>{r.forEach((r=>{if(r.default)return e(r.ip),void(n=1)})),n||e("127.0.0.1")}))}function configStartMerge(e){for(var r,n,o=Array.prototype.slice.call(arguments,0);o.length;)for(n in r=o.shift())if(r.hasOwnProperty(n))if("object"==typeof e[n]&&e[n]&&"[object Array]"!==Object.prototype.toString.call(e[n]))"object"==typeof r[n]&&null!==r[n]?e[n]=configStartMerge({},e[n],r[n]):e[n]=r[n];else if("[object Array]"==Object.prototype.toString.call(e[n]))e[n]=configStartMerge([],e[n],r[n]);else if("[object Object]"==Object.prototype.toString.call(e[n]))e[n]=configStartMerge({},e[n],r[n]);else if("[object Function]"==Object.prototype.toString.call(e[n])){let o=JSON.stringify(r[n],replacer,2);o=o.slice(0,-1),o=o.slice(1),e[n]=o}else e[n]=r[n];return e}function configMerge(e){for(var r,n,o=Array.prototype.slice.call(arguments,1);o.length;)for(n in r=o.shift())r.hasOwnProperty(n)&&("object"==typeof e[n]&&e[n]&&"[object Array]"!==Object.prototype.toString.call(e[n])&&"object"==typeof r[n]&&null!==r[n]?e[n]=configMerge({},e[n],r[n]):e[n]=r[n]);return e}function checkElectronOptions(e){return!("object"!=typeof e.electronOptions||"object"!=typeof e.electronOptions.webPreferences||!e.electronOptions.webPreferences.webviewTag)}function setWebviewTag(e){return new Promise((r=>{r(e=configMerge({},e,{electronOptions:{webPreferences:{webviewTag:!0}}}))}))}function restartMM(e){e.config.usePM2?(console.log("[GATEWAY] PM2 will restarting MagicMirror..."),e.lib.pm2.restart(e.config.PM2Id,((e,r)=>{e&&console.log("[GATEWAY] "+e)}))):doRestart(e)}function doRestart(e){console.log("[GATEWAY] Restarting MagicMirror...");var r=e.lib.path.normalize(__dirname+"/../../../");const n=process.stdout,o=process.stderr;e.lib.childProcess.spawn("npm start",{cwd:r,shell:!0,detached:!0,stdio:["ignore",n,o]}).unref(),process.exit()}function doClose(e){console.log("[GATEWAY] Closing MagicMirror..."),e.config.usePM2?e.lib.pm2.stop(e.config.PM2Id,((e,r)=>{e&&console.log("[GATEWAY] "+e)})):process.exit()}function getGAConfig(e){var r=e.modules.map((e=>e.module)).indexOf("MMM-GoogleAssistant");return r>-1?e.modules[r]:{}}function makeSchemaTranslate(e,r){function n(e){return e.replace(new RegExp("{([^}]+)}","g"),(function(n,o){return o in r==!1&&console.warn("[GATEWAY][Translator] Missing:",e),o in r?r[o]:"{"+o+"}"}))}return function e(r){for(var o,t,i=Array.prototype.slice.call(arguments,0);i.length;)for(t in o=i.shift())o.hasOwnProperty(t)&&("object"==typeof r[t]&&r[t]&&"[object Array]"!==Object.prototype.toString.call(r[t])?"object"==typeof o[t]&&null!==o[t]?r[t]=e({},r[t],o[t]):r[t]=o[t]:"title"!=t&&"description"!=t||!r[t]?r[t]=o[t]:r[t]=n(o[t]));return r}(e)}function readAllMMLogs(e){return new Promise((r=>{var n="";e.forEach((e=>{n+=e.replace(/\r?\n/g,"\r\n")})),r(n)}))}function replacer(e,r){return"function"==typeof r?"[FUNCTION]"+r.toString():r}function reviver(e){var r=e[3].replace(/\\n/g,"\n");return r=r.replace(/\\/g,""),e[1]+r}exports.purposeIP=purposeIP,exports.readConfig=readConfig,exports.saveConfig=saveConfig,exports.configAddOrModify=configAddOrModify,exports.configDelete=configDelete,exports.searchConfigured=searchConfigured,exports.searchInstalled=searchInstalled,exports.loadBackupNames=loadBackupNames,exports.loadBackupFile=loadBackupFile,exports.configMerge=configMerge,exports.checkElectronOptions=checkElectronOptions,exports.doClose=doClose,exports.restartMM=restartMM,exports.searchGA=searchGA,exports.getGAConfig=getGAConfig,exports.setWebviewTag=setWebviewTag,exports.deleteBackup=deleteBackup,exports.makeSchemaTranslate=makeSchemaTranslate,exports.readAllMMLogs=readAllMMLogs,exports.readFreeteuseTV=readFreeteuseTV,exports.readRadioRecipe=readRadioRecipe,exports.transformExternalBackup=transformExternalBackup,exports.saveExternalConfig=saveExternalConfig,exports.deleteDownload=deleteDownload;